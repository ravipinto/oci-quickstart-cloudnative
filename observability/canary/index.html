<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <title>Canary Deployment :: MuShop</title>
  
  <meta name="application-name" content="MuShop"/>
<meta name="description" content="Oracle Cloud Native Workshop">
<meta name="keywords" content="Kubernetes,OCI,OKE,Microservices">

<meta property="og:title" content="MuShop - Canary Deployment" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/observability/canary/" />
    <link rel="apple-touch-icon" sizes="180x180" href="../../icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../icons/favicon-16x16.png">
  <link rel="manifest" href="../../icons/site.webmanifest">
  <link rel="mask-icon" href="../../icons/safari-pinned-tab.svg" color="#41727e">
  <meta name="msapplication-TileColor" content="#c74634">
  <meta name="theme-color" content="#fcfbfa">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" type="text/css" href="../../sass/main.min.579b1ef900caab9f4034f2fab782c459ab9ddb6c2dd914fed6155812ffd82484.css" integrity="sha256-V5se&#43;QDKq59ANPL6t4LEWaud22wt2RT&#43;1hVYEv/YJIQ=">
  <link rel="stylesheet" type="text/css" href="../../fonts/fonts.min.58744946497c59fa8a6ac77636ea480457079e54512cf3dcb552592b56503cc1.css" integrity="sha256-WHRJRkl8WfqKasd2NupIBFcHnlRRLPPctVJZK1ZQPME=">
  <link rel="stylesheet" type="text/css" href="../../sass/mushop.min.c31ca585e7b3a90dfeb2fd0ac2d7d93ff0af82ea19b0cab20c8539d987761606.css" integrity="sha256-wxylheezqQ3&#43;sv0KwtfZP/CvguoZsMqyDIU52Yd2FgY=">
</head>

  <body class="" data-url="../../observability/canary/">
    
<div class="uk-navbar-container uk-hidden@s">
  <div class="">
    <nav role="navigation" class="uk-light uk-navbar" uk-navbar>
      <div class="uk-navbar-left">
        <a href="../../index.html" class="uk-navbar-item uk-logo">
          <img
            alt="MuShop"
            class="uk-width-small"
            src="../../images/logo.dark.png">
        </a>
      </div>
      <div class="uk-navbar-right">
        <a class="uk-navbar-toggle" uk-navbar-toggle-icon uk-toggle="target: #navigation"></a>
      </div>
    </nav>
  </div>
</div>


<div class="uk-grid">
  
  
  <aside
    id="navigation"
    class="rw-sidebar uk-offcanvas uk-width-1-1 uk-width-1-3@s uk-width-1-4@m uk-width-1-5@l uk-width-1-6@xl uk-light uk-padding-remove"
    uk-offcanvas="overlay: true;">
    <div class="uk-offcanvas-bar uk-padding-small">
      
      
      <section>
        <div class="uk-margin-bottom uk-visible@s">
          <a href="../../index.html" class="uk-logo">
            <img src="../../images/logo.dark.png" alt="MuShop">
          </a>
        </div>
        <div class="uk-margin-bottom">
          <form class="uk-search uk-search-default uk-width-expand">
  <span class="uk-search-icon-flip" uk-search-icon></span>
  <input id="search" class="uk-search-input uk-width-expand" type="search" placeholder="Search...">
</form>
<div id="search-results" class="uk-background-primary uk-text-small"></div>
        </div>
        <ul class="uk-nav uk-nav-primary" uk-nav="multiple: true; toggle: > a .uk-icon">
          <li class="uk-nav-divider"></li>
          
            


  
  
  
  <li data-nav-id="/introduction/" title="Introduction" class="">
    <a href="../../introduction/">
      <div class="uk-flex uk-flex-between uk-flex-middle">
        <div class="uk-text-truncate">Introduction</div>
      </div>
    </a>
    
    
  </li>
  

 

          
            


  
  
  
  <li data-nav-id="/quickstart/" title="Getting Started" class=" uk-parent">
    <a href="../../quickstart/">
      <div class="uk-flex uk-flex-between uk-flex-middle">
        <div class="uk-text-truncate">Getting Started</div><span class="uk-flex-none" uk-icon="icon: triangle-right; ratio: 1.5"></span>
      </div>
    </a>
    
    
    <ul class="uk-nav-sub">
      
      
      
      
      
        
        


  
    
    <li data-nav-id="/quickstart/basic/" title="Always Free" class="">
      <a href="../../quickstart/basic/" class="uk-text-truncate">
        Always Free
      </a>
    </li>
    
  

 

        
      
        
        


  
    
    <li data-nav-id="/quickstart/kubernetes/" title="Kubernetes Deployment" class="">
      <a href="../../quickstart/kubernetes/" class="uk-text-truncate">
        Kubernetes Deployment
      </a>
    </li>
    
  

 

        
      
    </ul>
  
  </li>
  

 

          
            


  
  
  
  <li data-nav-id="/cloud/" title="Cloud Infrastructure" class=" uk-parent">
    <a href="../../cloud/">
      <div class="uk-flex uk-flex-between uk-flex-middle">
        <div class="uk-text-truncate">Cloud Infrastructure</div><span class="uk-flex-none" uk-icon="icon: triangle-right; ratio: 1.5"></span>
      </div>
    </a>
    
    
    <ul class="uk-nav-sub">
      
      
      
      
      
        
        


  
    
    <li data-nav-id="/cloud/prerequisites/" title="Prerequisites" class="">
      <a href="../../cloud/prerequisites/" class="uk-text-truncate">
        Prerequisites
      </a>
    </li>
    
  

 

        
      
        
        


  
    
    <li data-nav-id="/cloud/setup/" title="Setup" class="">
      <a href="../../cloud/setup/" class="uk-text-truncate">
        Setup
      </a>
    </li>
    
  

 

        
      
        
        


  
    
    <li data-nav-id="/cloud/deployment/" title="Deployment" class="">
      <a href="../../cloud/deployment/" class="uk-text-truncate">
        Deployment
      </a>
    </li>
    
  

 

        
      
    </ul>
  
  </li>
  

 

          
            


  
  
  
  <li data-nav-id="/observability/" title="Observability" class=" uk-parent uk-open">
    <a href="../../observability/">
      <div class="uk-flex uk-flex-between uk-flex-middle">
        <div class="uk-text-truncate">Observability</div><span class="uk-flex-none" uk-icon="icon: triangle-right; ratio: 1.5"></span>
      </div>
    </a>
    
    
    <ul class="uk-nav-sub">
      
      
        
      
      
      
      
        
        


  
    
    <li data-nav-id="/observability/monitoring/" title="Grafana Monitoring" class="">
      <a href="../../observability/monitoring/" class="uk-text-truncate">
        Grafana Monitoring
      </a>
    </li>
    
  

 

        
      
        
        


  
    
    <li data-nav-id="/observability/istio/" title="Istio Service Mesh" class="">
      <a href="../../observability/istio/" class="uk-text-truncate">
        Istio Service Mesh
      </a>
    </li>
    
  

 

        
      
        
        


  
    
    <li data-nav-id="/observability/canary/" title="Canary Deployment" class="uk-active">
      <a href="../../observability/canary/" class="uk-text-truncate">
        Canary Deployment
      </a>
    </li>
    
  

 

        
      
        
        


  
    
    <li data-nav-id="/observability/oci-monitoring/" title="OCI Monitoring" class="">
      <a href="../../observability/oci-monitoring/" class="uk-text-truncate">
        OCI Monitoring
      </a>
    </li>
    
  

 

        
      
        
        


  
    
    <li data-nav-id="/observability/oci-healthcheck/" title="OCI Health Checks" class="">
      <a href="../../observability/oci-healthcheck/" class="uk-text-truncate">
        OCI Health Checks
      </a>
    </li>
    
  

 

        
      
        
        


  
  
  
  <li data-nav-id="/observability/observability-example/" title="Observability Example" class=" uk-parent">
    <a href="../../observability/observability-example/">
      <div class="uk-flex uk-flex-between uk-flex-middle">
        <div class="uk-text-truncate">Observability Example</div><span class="uk-flex-none" uk-icon="icon: triangle-right; ratio: 1.5"></span>
      </div>
    </a>
    
    
    <ul class="uk-nav-sub">
      
      
      
      
      
        
        


  
    
    <li data-nav-id="/observability/observability-example/setup/" title="Setup" class="">
      <a href="../../observability/observability-example/setup/" class="uk-text-truncate">
        Setup
      </a>
    </li>
    
  

 

        
      
        
        


  
    
    <li data-nav-id="/observability/observability-example/usecase/" title="Use Case" class="">
      <a href="../../observability/observability-example/usecase/" class="uk-text-truncate">
        Use Case
      </a>
    </li>
    
  

 

        
      
    </ul>
  
  </li>
  

 

        
      
    </ul>
  
  </li>
  

 

          
            


  
  
  
  <li data-nav-id="/extras/" title="Extras" class=" uk-parent">
    <a href="../../extras/">
      <div class="uk-flex uk-flex-between uk-flex-middle">
        <div class="uk-text-truncate">Extras</div><span class="uk-flex-none" uk-icon="icon: triangle-right; ratio: 1.5"></span>
      </div>
    </a>
    
    
    <ul class="uk-nav-sub">
      
      
      
      
      
        
        


  
    
    <li data-nav-id="/extras/jenkins/" title="Jenkins" class="">
      <a href="../../extras/jenkins/" class="uk-text-truncate">
        Jenkins
      </a>
    </li>
    
  

 

        
      
    </ul>
  
  </li>
  

 

          
            


  
  
  
  <li data-nav-id="/cleanup/" title="Cleanup" class="">
    <a href="../../cleanup/">
      <div class="uk-flex uk-flex-between uk-flex-middle">
        <div class="uk-text-truncate">Cleanup</div>
      </div>
    </a>
    
    
  </li>
  

 

          
          <li class="uk-nav-divider"></li>
        </ul>
      </section>
      
      <section>
        <ul class="uk-nav uk-nav-default" uk-nav>
          
          
          <li>
            <a title="More Information" href="../../resources" class="uk-text-truncate">
              <span uk-icon='icon: info; ratio: 1.25'></span>
              <span class="uk-text-middle">More Information</span>
              
            </a>
          </li>
          <li>
            <a title="Acknowledgements" href="../../acknowledgements" class="uk-text-truncate">
              <span uk-icon='icon: users; ratio: 1.25'></span>
              <span class="uk-text-middle">Acknowledgements</span>
              
            </a>
          </li>
          <li>
            <a title="Tags" href="../../tags" class="uk-text-truncate">
              <span uk-icon='icon: tag; ratio: 1.25'></span>
              <span class="uk-text-middle">Tags</span>
              
            </a>
          </li>
          <li>
            <a title="GitHub Source" href="https://github.com/oracle-quickstart/oci-cloudnative" class="uk-text-truncate">
              <span uk-icon='icon: github; ratio: 1.25'></span>
              <span class="uk-text-middle">GitHub Source</span>
              
            </a>
          </li>
          <li>
            <a title="Report Issue" href="https://github.com/oracle-quickstart/oci-cloudnative/issues" class="uk-text-truncate">
              <span uk-icon='icon: warning; ratio: 1.25'></span>
              <span class="uk-text-middle">Report Issue</span>
              
            </a>
          </li>
            <li>
              <a title='Edit this page' href="https://github.com/oracle-quickstart/oci-cloudnative/tree/master/src/docs/content/observability/canary.md" target="blank">
                <span uk-icon="pencil"></span>
                <span class="uk-text-middle">Edit this page</span>
              </a>
            </li>
            
          
        </ul>
      </section>
      <section class="uk-margin-top">
        <hr>
        <ul id="rw-settings" class="uk-nav uk-nav-default" uk-nav>
  <li class="uk-grid uk-grid-small uk-flex-middle uk-flex-between uk-flex-nowrap uk-text-nowrap">
  <div class="uk-width-1-4">
    
    <span>Theme</span>
  </div>
  <div class="uk-button-group rw-setting"
    setting="theme"
    target="html, .content-container" ><button class="uk-button uk-button-small uk-button-secondary
    uk-active" toggle="uk-background-default" >
      Light
    </button><button class="uk-button uk-button-small uk-button-secondary
    " toggle="uk-light uk-background-secondary" >
      Dark
    </button></div>
</li>


  <li class="uk-grid uk-grid-small uk-flex-middle uk-flex-between uk-flex-nowrap uk-text-nowrap">
  <div class="uk-width-1-4">
    
    <span>OS</span>
  </div>
  <div class="uk-button-group rw-setting"
    setting="platform"
    target="html" ><button class="uk-button uk-button-small uk-button-secondary
    uk-active" toggle="stg-os-macos" >
      Mac
    </button><button class="uk-button uk-button-small uk-button-secondary
    " toggle="stg-os-linux" >
      Linux
    </button><button class="uk-button uk-button-small uk-button-secondary
    " toggle="stg-os-windows" >
      Windows
    </button></div>
</li>
<li class="uk-grid uk-grid-small uk-flex-middle uk-flex-between uk-flex-nowrap uk-text-nowrap">
  <div class="uk-width-1-4">
    
    <span>Helm</span>
  </div>
  <div class="uk-button-group rw-setting"
    setting="helm"
    target="html" ><button class="uk-button uk-button-small uk-button-secondary
    uk-active" toggle="stg-helm-3" >
      3.x
    </button><button class="uk-button uk-button-small uk-button-secondary
    " toggle="stg-helm-2" >
      2.x
    </button></div>
</li>
</ul>



      </section>
      <section class="uk-text-small uk-text-lighter uk-margin-top">
        <hr>
        <div class="uk-text-muted">
  <div class="uk-margin-small">
    Made with <span uk-icon="icon: heart; ratio: 0.75"></span> by Oracle Developers
  </div>
  Copyright © 2021 Oracle and/or its affiliates. All rights reserved.
</div>
      </section>
    </div>
  </aside>
  
  <div class="uk-width-1-1 uk-width-1-3@s uk-width-1-4@m uk-width-1-5@l uk-width-1-6@xl uk-visible@s"></div>



    <div class="content-container uk-width-expand">
      <div class="uk-position-relative">
        <div id="content" class="uk-grid uk-container-xlarge" uk-grid>
          

<div class="uk-flex-last uk-width-1-4 uk-visible@l">
  <aside id="toc-nav" uk-sticky="offset: 40">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#pre-requisites">Pre-Requisites</a></li>
        <li><a href="#deploy-storefront-beta">Deploy storefront beta</a></li>
        <li><a href="#create-istio-resources">Create Istio resources</a></li>
        <li><a href="#testing">Testing</a></li>
        <li><a href="#noticing-the-issues">Noticing the issues</a></li>
        <li><a href="#roll-back">Roll Back</a></li>
        <li><a href="#cleanup">Cleanup</a></li>
      </ul>
    </li>
  </ul>
</nav>
    <hr/>
    
  <div>
    
    <a class="uk-label" href="../../tags/canary">
      <span uk-icon="tag"></span>
      Canary
    </a>
    
    <a class="uk-label" href="../../tags/patching">
      <span uk-icon="tag"></span>
      Patching
    </a>
    
  </div>

  </aside>
</div>


          <main class="uk-width-expand">
            <header>
  
  
    <ul class="uk-breadcrumb uk-margin-top uk-text-small">
    
  
  <li><a href='../../'>Home</a></li> <li><a href='../../observability/'>Observability</a></li> <li>Canary Deployment</li>
    </ul></header>



            <h1 class="rw-accent">Canary Deployment</h1>
              
  <div uk-alert class="uk-alert-warning uk-grid uk-grid-collapse uk-flex-nowrap "><span uk-icon="icon: warning; ratio: 1.2" class="uk-margin-small-right uk-flex-none"></span><div class="uk-width-expand">
<p>Note that this is <strong>OPTIONAL</strong>. This section is only applicable if you have completed <a href="../../observability/istio/">Istio service mesh</a> section.</p>
</div></div>
<h2 id="introduction">Introduction</h2>
<p>In this section we will demonstrate canary deployment use case with MuShop Application.</p>
<p>One of the benefits of the Istio project is that it provides the control needed to deploy canary services. The idea behind canary deployment (or rollout) is to introduce a new version of a service by first testing it using a small percentage of user traffic, and then if all goes well, increase, possibly gradually in increments, the percentage while simultaneously phasing out the old version. If anything goes wrong along the way, we abort and rollback to the previous version. In its simplest form, the traffic sent to the canary version is a randomly selected percentage of requests, but in more sophisticated schemes it can be based on the region, user, or other properties of the request. Read more details <a href="https://istio.io/latest/blog/2017/0.1-canary/">here</a></p>
<p>We shall demonstrate the simplest canary deployment by using two versions of storefront microservice (storefront:original and storefront:beta) and would split traffic between the two.</p>
<ul>
<li>storefront:original would be the original page which does not have the reviews feature.</li>
<li>storefront:beta would have a new feature called &ldquo;reviews&rdquo; displayed on the UI which would let the user&rsquo;s provide review for their products.</li>
</ul>
<p>Note: The builds storefront:original and storefront:beta naming conventions are used here for easier understanding.
Later during the procedure we will use the exact build version.</p>
<p>Lets look at the diagram which would explain the same</p>
<p><img src="../images/mesh/mushop-canary.png" alt="MuShop Canary Deployment"></p>
<div uk-alert class="uk-alert-warning uk-grid uk-grid-collapse uk-flex-nowrap "><span uk-icon="icon: warning; ratio: 1.2" class="uk-margin-small-right uk-flex-none"></span><div class="uk-width-expand">
<p>The path between users and storefront has many layers ( DNS -&gt; WAF -&gt; LB -&gt; INGRESS -&gt; Router -&gt; Storefront), The above figure shown is high level. Refer <a href="https://mushop.ateam.cloud/about.html">https://mushop.ateam.cloud/about.html</a> for more details.</p>
</div></div>
<p>We would configure and run the storefront services in an Istio-enabled environment, with Envoy sidecars injected along side each service. We configure the Istio http routing by creating a VirtualService and Destination rules. Storefront images are available on the Oracle Cloud Infrastructure Registry. We would use them to create a kubernetes deployment.</p>
<h2 id="pre-requisites">Pre-Requisites</h2>
<p>Deploy <a href="../../quickstart/kubernetes/">Mushop</a></p>
<p>Download and install <a href="../../observability/istio/">Istio Service Mesh</a></p>
<h2 id="deploy-storefront-beta">Deploy storefront beta</h2>
<ul>
<li>
<p>Create a deployment with the below config and name it mushop-storefrontv2.</p>
<p>Note: We will use the same labels as that of storefront original.</p>
</li>
</ul>
<pre><code class="language-shell--macos-linux" data-lang="shell--macos-linux">  cat &lt;&lt; EOF | kubectl apply -f -
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    labels:
      app.kubernetes.io/instance: mushop
      app.kubernetes.io/name: storefront
    name: mushop-storefrontv2
    namespace: mushop
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: storefront
        app.kubernetes.io/instance: mushop
        app.kubernetes.io/name: storefront
    template:
      metadata:
        labels:
          app: storefront
          app.kubernetes.io/instance: mushop
          app.kubernetes.io/name: storefront
          version: 2.1.3-beta.1
      spec:
        containers:
        - image: iad.ocir.io/oracle/ateam/mushop-storefront:2.1.3-beta.1
          imagePullPolicy: Always
          name: storefront
EOF
</code></pre><pre><code class="language-shell--win" data-lang="shell--win">&quot;apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: mushop
    app.kubernetes.io/name: storefront
  name: mushop-storefrontv2
  namespace: mushop
spec:
  replicas: 1
  selector:
    matchLabels:
      app: storefront
      app.kubernetes.io/instance: mushop
      app.kubernetes.io/name: storefront
  template:
    metadata:
      labels:
        app: storefront
        app.kubernetes.io/instance: mushop
        app.kubernetes.io/name: storefront
        version: 2.1.3-beta.1
    spec:
      containers:
      - image: iad.ocir.io/oracle/ateam/mushop-storefront:2.1.3-beta.1
        imagePullPolicy: Always
        name: storefront&quot; | kubectl apply -f -
</code></pre><h2 id="create-istio-resources">Create Istio resources</h2>
<ul>
<li>
<p>Deploy a Gateway resource</p>
<pre><code class="language-shell--macos-linux" data-lang="shell--macos-linux">  cat &lt;&lt; EOF | kubectl apply -f -
  apiVersion: networking.istio.io/v1alpha3
  kind: Gateway
  metadata:
    name: gateway
    namespace: mushop
  spec:
    selector:
      istio: ingressgateway
    servers:
      - port:
          number: 80
          name: http
          protocol: HTTP
        hosts:
          - '*'
EOF
</code></pre><pre><code class="language-shell--win" data-lang="shell--win">&quot;apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: gateway
  namespace: mushop
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - '*'&quot; | kubectl apply -f -
</code></pre></li>
<li>
<p>Deploy a VirtualService and DestinationRules</p>
<pre><code class="language-shell--macos-linux" data-lang="shell--macos-linux">  cat &lt;&lt;EOF | kubectl apply -f -
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
    name: edge
    namespace: mushop
  spec:
    hosts:
      - '*'
    gateways:
      - gateway
    http:
    - match:
      - uri:
          prefix: /api
      route:
      - destination:
          host: mushop-api.mushop.svc.cluster.local
    - match:
      - uri:
          prefix: /assets
      rewrite:
        uri: /
      route:
      - destination:
          host: mushop-assets.mushop.svc.cluster.local
    - route:
      - destination:
          host: mushop-storefront.mushop.svc.cluster.local
          subset: original
        weight: 50
      - destination:
          host: mushop-storefront.mushop.svc.cluster.local
          subset: beta
        weight: 50
EOF
</code></pre><pre><code class="language-shell--win" data-lang="shell--win">&quot;apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: edge
  namespace: mushop
spec:
  hosts:
    - '*'
  gateways:
    - gateway
  http:
  - match:
    - uri:
        prefix: /api
    route:
    - destination:
        host: mushop-api.mushop.svc.cluster.local
  - match:
    - uri:
        prefix: /assets
    rewrite:
      uri: /
    route:
    - destination:
        host: mushop-assets.mushop.svc.cluster.local
  - route:
    - destination:
        host: mushop-storefront.mushop.svc.cluster.local
        subset: original
      weight: 50
    - destination:
        host: mushop-storefront.mushop.svc.cluster.local
        subset: beta
      weight: 50 | kubectl apply -f -
</code></pre><ul>
<li>Destination Rule</li>
</ul>
<pre><code class="language-shell--macos-linux" data-lang="shell--macos-linux">cat &lt;&lt;EOF | k apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-destination
spec:
  host: mushop-storefront.mushop.svc.cluster.local
  subsets:
  - name: original
    labels:
      version: 2.1.2
  - name: beta
    labels:
      version: 2.1.3-beta.1
EOF
</code></pre><pre><code class="language-shell--win" data-lang="shell--win">&quot;apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-destination
spec:
  host: mushop-storefront.mushop.svc.cluster.local
  subsets:
  - name: original
    labels:
      version: 2.1.2
  - name: beta
    labels:
      version: 2.1.3-beta.1&quot; | kubectl apply -f -
</code></pre></li>
<li>
<p>Open a browser with the EXTERNAL-IP of the Istio ingress gateway</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">  kubectl get svc istio-ingressgateway <span class="se">\
</span><span class="se"></span>    --namespace istio-system
</code></pre></div><blockquote>
<p>Locating <code>EXTERNAL-IP</code> for Istio Ingress Gateway. <strong>NOTE</strong> this will be
<a href="https://localhost">localhost</a> on local clusters.</p>
</blockquote>
</li>
</ul>
<h2 id="testing">Testing</h2>
<p>Open a Incognito/Private window of a browser and access http://EXTERNAL-IP/.</p>
<p>Try to refreshing the URL multiple times and you would see two different storefront UI&rsquo;s (original and beta) with 50% of traffic going to each.</p>
<div uk-alert class="uk-alert-warning uk-grid uk-grid-collapse uk-flex-nowrap "><span uk-icon="icon: info; ratio: 1.2" class="uk-margin-small-right uk-flex-none"></span><div class="uk-width-expand">
<p>We can also change the percentage of traffic from 50:50 to 90:10. For more focused canary testing using Header and URI matching <a href="https://istio.io/latest/blog/2017/0.1-canary/#focused-canary-testing">refer</a></p>
</div></div>
<h2 id="noticing-the-issues">Noticing the issues</h2>
<ul>
<li>Review page ratings star icon wont fill when clicked.</li>
</ul>
<h2 id="roll-back">Roll Back</h2>
<ul>
<li>
<p>We would change the routing back to default as below</p>
<pre><code class="language-shell--macos-linux" data-lang="shell--macos-linux">  cat &lt;&lt;EOF | kubectl apply -f -
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
    name: edge
    namespace: mushop
  spec:
    hosts:
      - '*'
    gateways:
      - gateway
    http:
    - match:
      - uri:
          prefix: /api
      route:
      - destination:
          host: mushop-api.mushop.svc.cluster.local
    - match:
      - uri:
          prefix: /assets
      rewrite:
        uri: /
      route:
      - destination:
          host: mushop-assets.mushop.svc.cluster.local
    - route:
      - destination:
          host: mushop-storefront.mushop.svc.cluster.local
          port:
            number: 80
EOF
</code></pre><pre><code class="language-shell--win" data-lang="shell--win">&quot;apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: edge
  namespace: mushop
spec:
  hosts:
    - '*'
  gateways:
    - gateway
  http:
  - match:
    - uri:
        prefix: /api
    route:
    - destination:
        host: mushop-api.mushop.svc.cluster.local
  - match:
    - uri:
        prefix: /assets
    rewrite:
      uri: /
    route:
    - destination:
        host: mushop-assets.mushop.svc.cluster.local
  - route:
    - destination:
        host: mushop-storefront.mushop.svc.cluster.local
        port:
          number: 80&quot; | kubectl apply -f -
</code></pre></li>
</ul>
<h2 id="cleanup">Cleanup</h2>
<p>Uninstall Istio by passing the generated manifests into <code>kubectl delete</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">istioctl manifest generate --set <span class="nv">profile</span><span class="o">=</span>demo <span class="p">|</span> kubectl delete -f -
</code></pre></div><p>Mushop Cleanup <a href="../../cleanup/">refer</a></p>


            </main>
          </div> 
        </div> 
      </div> 
    </div> 
    
<footer class="uk-position-fixed uk-position-bottom">
  <div class="uk-grid">
    
    
    <div class="uk-width-1-1 uk-width-1-3@s uk-width-1-4@m uk-width-1-5@l uk-width-1-6@xl uk-visible@s"></div>
    <div class="uk-width-expand">
      <div>
      
      
      
      


  
    
    
  

  
  
  
    
  

  
  
    


  
    
      
      
    
  

  
  
  

  
  


  
    


  
    
  

  
  
  

  
  
    


  
    
  

  
  
  

  
  


  
    


  
    
  

  
  
  

  
  


  


  
    


  
    
  

  
  
  

  
  
    


  
    
  

  
  
  

  
  


  
    


  
    
  

  
  
  

  
  


  
    


  
    
  

  
  
  

  
  


  


  
    


  
    
    
  

  
  
  
    
  

  
  
    


  
    
      
      
    
  

  
  
  

  
  


  
    


  
    
  

  
  
  

  
  


  
    


  
    
    
  

  
  
  

  
  


  
    


  
    
      
      
    
  

  
  
  

  
  


  
    


  
    
  

  
  
  

  
  


  
    


  
    
  

  
  
  

  
  
    


  
    
  

  
  
  

  
  


  
    


  
    
  

  
  
  

  
  


  


  


  
    


  
    
  

  
  
  

  
  
    


  
    
  

  
  
  

  
  


  


  
    


  
    
  

  
  
  

  
  


  


        <div class="uk-flex uk-flex-between uk-margin-top">
          <a href="../../observability/istio/" title="Istio Service Mesh" class="rw-page-prev uk-flex-first uk-flex uk-flex-left uk-flex-middle uk-text-truncate">
            <span uk-icon="icon: chevron-left; ratio: 2.5" class="uk-margin-small-right uk-flex-none"></span>
            <label class="uk-visible@m">Istio Service Mesh</label>
          </a><span></span>
          <a href="../../observability/oci-monitoring/" title="OCI Monitoring" class="rw-page-next uk-flex-last uk-flex uk-flex-right uk-flex-middle uk-flex-last uk-text-truncate">
            <label class="uk-visible@m">OCI Monitoring</label>
            <span uk-icon="icon: chevron-right; ratio: 2.5" class="uk-margin-small-left uk-flex-none"></span>
          </a></div>
      </div>
    </div>
  </div>
</footer>


    <script type="text/javascript">
  (function(w, s) {
    Object.assign(s, {
      BaseURL: '',
      RelURL: '\/',
      cssConfig: {
        table: 'uk-table uk-table-small uk-table-striped',
        '#TableOfContents > ul': 'uk-nav uk-nav-default uk-nav-parent-icon',
        '#TableOfContents > ul ul': 'uk-nav-sub',
      },
      uikit: {
        '#TableOfContents > ul': ['scrollspyNav', { closest: 'li', offset: 10 }],
        
      }
    });
  })(window, window.Site = window.Site || {});
</script>

<script src="../../js/vendor.min.635fbc23a7f80d0fcee6728a32611ece1edb8302f818f627011b23dc8de8c6d4.js" ></script><script src="../../js/extras.min.a9bf7ac5b6f2ffe1f85649105cb5f3065ab48c7ce45fa8efd51bce9622933221.js"  async></script><script src="../../js/site.min.5a6d5008222f09cfe0ff51eb81d80c68d7d2fa56fa9ea1dd327f239f4c5d044d.js"  async></script>
  </body>
</html>